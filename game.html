<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego - Brain Games Storm</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .game-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .game-header {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .player-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .avatar-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .avatar-option {
            width: 60px;
            height: 60px;
            border: 3px solid transparent;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .avatar-option:hover {
            transform: scale(1.1);
            border-color: #667eea;
        }
        
        .avatar-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .name-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin: 20px 0;
            text-align: center;
        }
        
        .join-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .join-btn:hover {
            transform: translateY(-2px);
        }
        
        .join-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .waiting-area {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        
        .player-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .player-avatar {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Loading inicial -->
        <div id="loadingArea" class="loading">
            <div class="spinner"></div>
            <h2>Cargando juego...</h2>
        </div>
        
        <!-- Error si no se puede cargar -->
        <div id="errorArea" class="error-message" style="display: none;">
            <h2><i class="fas fa-exclamation-triangle"></i> Error</h2>
            <p id="errorMessage">No se pudo cargar el juego</p>
            <button class="btn btn-primary" onclick="window.location.href='index.html'">
                Volver al inicio
            </button>
        </div>
        
        <!-- Formulario para unirse al juego -->
        <div id="joinArea" style="display: none;">
            <div class="game-header">
                <h1><i class="fas fa-brain"></i> Brain Games Storm</h1>
                <h2 id="quizTitle">Cargando...</h2>
                <p id="gameCodeInfo" style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin: 10px 0; font-weight: bold;">
                    C√≥digo del juego: <span id="displayGameCode">------</span>
                </p>
                <p>¬°√önete al juego!</p>
            </div>
            
            <div class="player-form">
                <h3>Elige tu avatar y nombre</h3>
                
                <div class="avatar-selector" id="avatarSelector">
                    <!-- Los avatares se cargar√°n din√°micamente -->
                </div>
                
                <input type="text" 
                       id="playerName" 
                       class="name-input" 
                       placeholder="Escribe tu nombre..." 
                       maxlength="20">
                
                <button id="joinGameBtn" class="join-btn" onclick="joinCurrentGame()">
                    <i class="fas fa-play"></i> Unirse al Juego
                </button>
            </div>
        </div>
        
        <!-- √Årea de espera -->
        <div id="waitingArea" class="waiting-area">
            <div class="game-header">
                <h1 id="waitingQuizTitle">Quiz Title</h1>
                <p>Esperando a que el profesor inicie el juego...</p>
            </div>
            
            <div class="players-list" id="playersList">
                <!-- Lista de jugadores se cargar√° din√°micamente -->
            </div>
            
            <p><strong id="playersCount">0</strong> jugadores conectados</p>
        </div>
        
        <!-- √Årea del juego (se cargar√° student.html content) -->
        <div id="gameArea" style="display: none;">
            <!-- El contenido del juego se cargar√° aqu√≠ -->
        </div>
    </div>

    <!-- Scripts -->
    <script src="script.js"></script>
    <script src="firebase-simple.js"></script>
    <script>
        let currentGame = null;
        let gameId = null;
        let playerId = null;
        
        // Avatares disponibles
        const avatars = ['üòé', 'ü§ì', 'üòä', 'ü•≥', 'üöÄ', '‚≠ê', 'üéØ', 'üèÜ', 'üé≠', 'üé®', 'üé™', 'üé≠', 'ü¶Ñ', 'üåü', 'üíé', 'üî•', '‚ö°', 'üåà', 'üéµ', 'üé∏'];
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
        });
        
        function initializeGame() {
            try {
                // Obtener par√°metros de la URL
                const urlParams = new URLSearchParams(window.location.search);
                const quizId = urlParams.get('quiz');
                gameId = urlParams.get('game');
                
                if (!quizId || !gameId) {
                    // Intentar recuperar de localStorage como fallback
                    const activeGame = localStorage.getItem('activeGame');
                    if (activeGame) {
                        const gameInfo = JSON.parse(activeGame);
                        if (gameInfo.gameCode && gameInfo.quizId) {
                            console.log('üìã Recuperando juego activo desde localStorage');
                            // Actualizar URL sin recargar
                            const newUrl = `${window.location.pathname}?quiz=${gameInfo.quizId}&game=${gameInfo.gameCode}`;
                            window.history.replaceState({}, '', newUrl);
                            // Reinicializar con los par√°metros correctos
                            setTimeout(initializeGame, 100);
                            return;
                        }
                    }
                    
                    showError('URL de juego inv√°lida. Accede desde el panel de administraci√≥n o proporciona los par√°metros: quiz=ID&game=CODIGO');
                    return;
                }
                
                // Cargar informaci√≥n del juego
                console.log('üéÆ Cargando juego:', { quizId, gameId });
                
                // Obtener el quiz desde localStorage
                const quiz = getQuizById(quizId);
                if (!quiz) {
                    showError(`Quiz con ID ${quizId} no encontrado. Aseg√∫rate de que el quiz exista.`);
                    return;
                }
                
                // Crear objeto de juego
                currentGame = {
                    quiz: quiz,
                    gameCode: gameId,
                    players: [],
                    status: 'waiting'
                };
                
                console.log('‚úÖ Juego cargado exitosamente:', currentGame);
                
                // Configurar la interfaz
                setupGameInterface();
                
            } catch (error) {
                console.error('Error al inicializar:', error);
                showError('Error al cargar el juego');
            }
        }
        
        function setupGameInterface() {
            // Ocultar loading
            document.getElementById('loadingArea').style.display = 'none';
            
            // Mostrar √°rea de uni√≥n
            document.getElementById('joinArea').style.display = 'block';
            
            // Configurar t√≠tulo y c√≥digo
            document.getElementById('quizTitle').textContent = currentGame.quiz.title;
            document.getElementById('displayGameCode').textContent = gameId;
            
            // Configurar avatares
            setupAvatars();
            
            // Configurar nombre input
            const nameInput = document.getElementById('playerName');
            nameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    joinCurrentGame();
                }
            });
            nameInput.focus();
        }
        
        function setupAvatars() {
            const avatarSelector = document.getElementById('avatarSelector');
            avatarSelector.innerHTML = '';
            
            avatars.forEach((avatar, index) => {
                const avatarElement = document.createElement('div');
                avatarElement.className = 'avatar-option';
                avatarElement.textContent = avatar;
                avatarElement.onclick = () => selectAvatar(avatarElement, avatar);
                
                if (index === 0) {
                    avatarElement.classList.add('selected');
                    avatarElement.dataset.selected = 'true';
                }
                
                avatarSelector.appendChild(avatarElement);
            });
        }
        
        function selectAvatar(element, avatar) {
            // Quitar selecci√≥n anterior
            document.querySelectorAll('.avatar-option').forEach(el => {
                el.classList.remove('selected');
                el.dataset.selected = 'false';
            });
            
            // Seleccionar nuevo avatar
            element.classList.add('selected');
            element.dataset.selected = 'true';
        }
        
        function getSelectedAvatar() {
            const selected = document.querySelector('.avatar-option[data-selected="true"]');
            return selected ? selected.textContent : avatars[0];
        }
        
        async function joinCurrentGame() {
            const playerName = document.getElementById('playerName').value.trim();
            
            if (!playerName) {
                alert('Por favor ingresa tu nombre');
                return;
            }
            
            if (playerName.length > 20) {
                alert('El nombre debe tener m√°ximo 20 caracteres');
                return;
            }
            
            const selectedAvatar = getSelectedAvatar();
            
            try {
                console.log('üë§ Intentando unirse al juego:', { gameId, playerName, selectedAvatar });
                
                // Usar Firebase para unirse al juego
                playerId = await window.joinFirebaseGame(gameId, playerName, selectedAvatar);
                
                if (!playerId) {
                    showError('‚ùå No se pudo unir al juego. Verifica el c√≥digo.');
                    return;
                }
                
                console.log('‚úÖ Unido al juego exitosamente, ID:', playerId);
                
                // Cambiar a √°rea de espera
                showWaitingArea();
                
                // Iniciar listeners en tiempo real
                startRealtimeListeners();
                
            } catch (error) {
                console.error('‚ùå Error al unirse:', error);
                showError('‚ùå Error al unirse al juego: ' + error.message);
            }
        }
        
        // Iniciar listeners de Firebase en tiempo real
        function startRealtimeListeners() {
            if (typeof window.listenToGameChanges === 'function') {
                console.log('üîÑ Iniciando escucha en tiempo real...');
                
                window.listenToGameChanges(gameId, (gameData) => {
                    console.log('üì° Cambios del juego recibidos:', gameData);
                    updateGameUI(gameData);
                });
            } else {
                console.warn('‚ö†Ô∏è Firebase listeners no disponibles, usando polling');
                startPlayerListUpdate();
            }
        }
        
        // Actualizar UI del juego con datos de Firebase
        function updateGameUI(gameData) {
            try {
                // Actualizar lista de jugadores
                updatePlayersListFromFirebase(gameData.players || []);
                
                // Verificar estado del juego
                const status = gameData.status || 'waiting';
                console.log('üéÆ Estado del juego:', status);
                
                if (status === 'playing' && gameData.currentQuestion !== undefined) {
                    // El juego ha comenzado - mostrar pregunta
                    showCurrentQuestion(gameData);
                } else if (status === 'finished') {
                    // Juego terminado - mostrar resultados
                    showGameResults();
                }
                
            } catch (error) {
                console.error('‚ùå Error actualizando UI del juego:', error);
            }
        }
        
        function updatePlayersListFromFirebase(playersArray) {
            const playersList = document.getElementById('playersList');
            const playersCount = document.getElementById('playersCount');
            
            if (playersList) {
                playersList.innerHTML = playersArray.map(player => `
                    <div class="player-item ${player.id === playerId ? 'current-player' : ''}">
                        <span class="player-avatar">${player.avatar || 'üë§'}</span>
                        <span class="player-name">${player.name || 'Sin nombre'}</span>
                        ${player.id === playerId ? '<span class="you-badge">T√∫</span>' : ''}
                    </div>
                `).join('');
            }
            
            if (playersCount) {
                playersCount.textContent = playersArray.length;
            }
        }
        
        function showWaitingArea() {
            document.getElementById('joinArea').style.display = 'none';
            document.getElementById('waitingArea').style.display = 'block';
            
            // Mostrar informaci√≥n del juego
            if (currentGame && currentGame.quiz) {
                document.getElementById('waitingQuizTitle').textContent = currentGame.quiz.title;
            } else {
                document.getElementById('waitingQuizTitle').textContent = `Juego ${gameId}`;
            }
        }
        

        
        // Mostrar pregunta actual cuando el juego inicia
        function showCurrentQuestion(gameData) {
            console.log('üìã Mostrando pregunta del juego:', gameData);
            
            // Ocultar √°rea de espera y mostrar pregunta
            document.getElementById('waitingArea').style.display = 'none';
            
            // Aqu√≠ redirigimos a student.html con par√°metros de Firebase
            const gameURL = `student.html?quiz=${gameData.quizId || currentGame.quiz.id}&game=${gameId}&player=${playerId}`;
            window.location.href = gameURL;
        }
        
        // Mostrar resultados cuando el juego termina
        function showGameResults() {
            console.log('üèÜ Juego terminado, mostrando resultados...');
            alert('üèÅ ¬°El juego ha terminado! Gracias por participar.');
            
            // Redirigir a p√°gina de resultados o admin
            window.location.href = 'admin.html';
        }
        
        function showError(message) {
            document.getElementById('loadingArea').style.display = 'none';
            document.getElementById('joinArea').style.display = 'none';
            document.getElementById('waitingArea').style.display = 'none';
            
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorArea').style.display = 'block';
        }
    </script>
</body>
</html>